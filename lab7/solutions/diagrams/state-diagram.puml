@startuml state-diagram
!define BLUE #4A90E2
!define GREEN #7ED321
!define ORANGE #F5A623
!define RED #D0021B
!define GRAY #9B9B9B

skinparam state {
    BackgroundColor BLUE
    BorderColor #2E5C8A
    FontColor white
    FontSize 12
    ArrowColor #2E5C8A
    ArrowThickness 2
}

skinparam state<<initial>> {
    BackgroundColor GREEN
}

skinparam state<<final>> {
    BackgroundColor GRAY
}

skinparam state<<error>> {
    BackgroundColor RED
}

skinparam state<<process>> {
    BackgroundColor ORANGE
}

title Диаграмма состояний заказа аренды спортивного оборудования\nСистема SportRent

[*] --> Инициализация : Создание заказа

state Инициализация <<initial>> {
    state "Инициализация" as Init
    Init : entry/ Создать объект заказа
    Init : do/ Инициализировать данные клиента
    Init : do/ Загрузить каталог оборудования
    Init : exit/ Сохранить временный ID заказа
}

Инициализация --> ВыборОборудования : Каталог загружен

state ВыборОборудования {
    state "Выбор оборудования" as Select
    Select : entry/ Отобразить доступное оборудование
    Select : do/ Клиент просматривает товары
    Select : do/ Добавление/удаление из заказа
    Select : do/ Проверка наличия на складе
    Select : exit/ Зафиксировать выбранные позиции
}

ВыборОборудования --> ВыборОборудования : Изменение состава заказа
ВыборОборудования --> РасчетСтоимости : Оборудование выбрано

state РасчетСтоимости <<process>> {
    state "Расчет стоимости" as Calc
    Calc : entry/ Получить цены позиций
    Calc : do/ Рассчитать стоимость аренды
    Calc : do/ Применить скидки/акции
    Calc : do/ Рассчитать залог
    Calc : exit/ Сформировать итоговую сумму
}

РасчетСтоимости --> ОформлениеЗаказа : Стоимость рассчитана

state ОформлениеЗаказа {
    state "Оформление заказа" as Form
    Form : entry/ Открыть форму оформления
    Form : do/ Заполнение контактных данных
    Form : do/ Выбор периода аренды
    Form : do/ Указание способа получения
    Form : do/ Выбор метода оплаты
    Form : exit/ Валидация введенных данных
}

ОформлениеЗаказа --> ВыборОборудования : Изменить заказ
ОформлениеЗаказа --> ОплатаЗаказа : Данные корректны

state ОплатаЗаказа <<process>> {
    state "Оплата заказа" as Pay
    Pay : entry/ Создать платежную транзакцию
    Pay : do/ Обработка оплаты
    Pay : do/ Взаимодействие с платежной системой
    Pay : do/ Списание залога
    Pay : exit/ Запись статуса оплаты
}

state Развилка <<choice>>
ОплатаЗаказа --> Развилка : Ответ от платежной системы

Развилка --> ПодтверждениеЗаказа : [Оплата успешна]
Развилка --> ОшибкаОплаты : [Ошибка оплаты]

state ОшибкаОплаты <<error>> {
    state "Ошибка оплаты" as PayError
    PayError : entry/ Логирование ошибки
    PayError : do/ Формирование сообщения об ошибке
    PayError : exit/ Отправка уведомления клиенту
}

ОшибкаОплаты --> ОплатаЗаказа : Повторить попытку
ОшибкаОплаты --> ОтменаЗаказа : Отмена клиентом

state ПодтверждениеЗаказа <<initial>> {
    state "Подтверждение заказа" as Confirm
    Confirm : entry/ Присвоить статус "Подтвержден"
    Confirm : do/ Отправить подтверждение на email
    Confirm : do/ Отправить SMS с деталями
    Confirm : do/ Создать договор аренды
    Confirm : do/ Зарезервировать оборудование
    Confirm : exit/ Уведомить склад о подготовке
}

ПодтверждениеЗаказа --> ПодготовкаКВыдаче : Заказ подтвержден

state ПодготовкаКВыдаче {
    state "Подготовка к выдаче" as Prep
    Prep : entry/ Назначить сотрудника склада
    Prep : do/ Проверка состояния оборудования
    Prep : do/ Комплектация заказа
    Prep : do/ Упаковка оборудования
    Prep : exit/ Уведомление о готовности
}

ПодготовкаКВыдаче --> ВыдачаОборудования : Готов к выдаче

state ВыдачаОборудования {
    state "Выдача оборудования" as Issue
    Issue : entry/ Проверить документы клиента
    Issue : do/ Демонстрация оборудования
    Issue : do/ Подписание акта приема-передачи
    Issue : do/ Фиксация состояния оборудования
    Issue : exit/ Передача оборудования клиенту
}

ВыдачаОборудования --> ВАренде : Оборудование выдано

state ВАренде {
    state "В аренде" as Active
    Active : entry/ Активировать договор аренды
    Active : do/ Мониторинг срока аренды
    Active : do/ Отправка напоминаний
    Active : exit/ Уведомление о приближении срока возврата
}

ВАренде --> ПродлениеАренды : Запрос продления
ВАренде --> ВозвратОборудования : Срок аренды истекает

state ПродлениеАренды <<process>> {
    state "Продление аренды" as Extend
    Extend : entry/ Проверить доступность оборудования
    Extend : do/ Расчет доплаты
    Extend : do/ Оплата продления
    Extend : exit/ Обновить срок аренды
}

state РазвилкаПродления <<choice>>
ПродлениеАренды --> РазвилкаПродления : Проверка оплаты

РазвилкаПродления --> ВАренде : [Продление оплачено]
РазвилкаПродления --> ВозвратОборудования : [Отказ от продления]

state ВозвратОборудования {
    state "Возврат оборудования" as Return
    Return : entry/ Прием оборудования на склад
    Return : do/ Проверка состояния оборудования
    Return : do/ Подписание акта возврата
    Return : do/ Оценка повреждений (если есть)
    Return : exit/ Фиксация факта возврата
}

state РазвилкаВозврата <<choice>>
ВозвратОборудования --> РазвилкаВозврата : Оценка состояния

РазвилкаВозврата --> ВозвратЗалога : [Оборудование в порядке]
РазвилкаВозврата --> ОбработкаПовреждений : [Есть повреждения]

state ОбработкаПовреждений <<process>> {
    state "Обработка повреждений" as Damage
    Damage : entry/ Оценить стоимость ущерба
    Damage : do/ Расчет компенсации
    Damage : do/ Удержание из залога
    Damage : do/ Создание отчета о повреждениях
    Damage : exit/ Уведомление клиента об удержании
}

ОбработкаПовреждений --> ВозвратЗалога : Компенсация рассчитана

state ВозвратЗалога <<process>> {
    state "Возврат залога" as Refund
    Refund : entry/ Рассчитать сумму к возврату
    Refund : do/ Инициировать возврат средств
    Refund : do/ Обработка транзакции
    Refund : exit/ Подтверждение возврата
}

ВозвратЗалога --> ЗакрытиеЗаказа : Залог возвращен

state ЗакрытиеЗаказа <<initial>> {
    state "Закрытие заказа" as Close
    Close : entry/ Присвоить статус "Завершен"
    Close : do/ Закрыть договор аренды
    Close : do/ Отправить чек и квитанции
    Close : do/ Запросить отзыв клиента
    Close : do/ Обновить статистику
    Close : exit/ Архивировать данные заказа
}

ЗакрытиеЗаказа --> [*] : Заказ завершен

state ОтменаЗаказа <<error>> {
    state "Отмена заказа" as Cancel
    Cancel : entry/ Присвоить статус "Отменен"
    Cancel : do/ Возврат средств (если оплачено)
    Cancel : do/ Освобождение резерва оборудования
    Cancel : do/ Отправка уведомления об отмене
    Cancel : exit/ Логирование причины отмены
}

Инициализация --> ОтменаЗаказа : Отмена клиентом
ВыборОборудования --> ОтменаЗаказа : Отмена клиентом
ОформлениеЗаказа --> ОтменаЗаказа : Отмена клиентом
ПодтверждениеЗаказа --> ОтменаЗаказа : Отмена до выдачи
ПодготовкаКВыдаче --> ОтменаЗаказа : Отмена до выдачи

ОтменаЗаказа --> [*] : Отмена обработана

note right of Инициализация
  Начальная стадия создания заказа.
  Система инициализирует необходимые
  данные для работы с заказом.
end note

note right of ВАренде
  Основное рабочее состояние.
  Оборудование находится у клиента.
  Система отслеживает сроки и
  отправляет напоминания.
end note

note bottom of РазвилкаВозврата
  Критическая точка: определяется
  необходимость компенсации за
  повреждения оборудования.
end note

@enduml
